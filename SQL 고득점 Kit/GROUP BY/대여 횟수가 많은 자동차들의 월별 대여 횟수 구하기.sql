USE programmers_groupBy;

CREATE TABLE CAR_RENTAL_COMPANY_RENTAL_HISTORY (
    HISTORY_ID INTEGER PRIMARY KEY,
    CAR_ID INTEGER NOT NULL,
    START_DATE DATE NOT NULL,
    END_DATE DATE NOT NULL
);

SHOW TABLES;

INSERT INTO CAR_RENTAL_COMPANY_RENTAL_HISTORY (HISTORY_ID, CAR_ID, START_DATE, END_DATE)
VALUES
    (1, 1, '2022-07-27', '2022-08-02'),
    (2, 1, '2022-08-03', '2022-08-04'),
    (3, 2, '2022-08-05', '2022-08-05'),
    (4, 2, '2022-08-09', '2022-08-12'),
    (5, 3, '2022-09-16', '2022-10-15'),
    (6, 1, '2022-08-24', '2022-08-30'),
    (7, 3, '2022-10-16', '2022-10-19'),
    (8, 1, '2022-09-03', '2022-09-07'),
    (9, 1, '2022-09-18', '2022-09-19'),
    (10, 2, '2022-09-08', '2022-09-10'),
    (11, 2, '2022-10-16', '2022-10-19'),
    (12, 1, '2022-09-29', '2022-10-06'),
    (13, 2, '2022-10-30', '2022-11-01'),
    (14, 2, '2022-11-05', '2022-11-05'),
    (15, 3, '2022-11-11', '2022-11-11');

SELECT * FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY;

SELECT 
    MONTH(START_DATE) AS MONTH, CAR_ID, COUNT(*) AS RECORDS
FROM
    CAR_RENTAL_COMPANY_RENTAL_HISTORY
WHERE
    START_DATE BETWEEN '2022-08-01' AND '2022-10-31'
        AND CAR_ID IN (SELECT 
            CAR_ID
        FROM
            CAR_RENTAL_COMPANY_RENTAL_HISTORY
        WHERE
            START_DATE BETWEEN '2022-08-01' AND '2022-10-31'
        GROUP BY CAR_ID
        HAVING COUNT(*) >= 5)
GROUP BY MONTH , CAR_ID
ORDER BY MONTH , CAR_ID DESC;